// ==============================================
// FACEBOOK CONVERSIONS API INTEGRATION SCRIPT
// ==============================================

// ==============================================
// UTILIT√ÅRIOS BASE
// ==============================================
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return undefined;
}

function setCookie(name, value, days = 365) {
  const expires = new Date();
  expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
  document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
}

function generateUUID() {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function getExternalId() {
  let externalId = getCookie('fb_external_id');
  if (!externalId) {
    externalId = generateUUID();
    setCookie('fb_external_id', externalId, 365);
  }
  return externalId;
}

function getUrlParameters() {
  const params = {};
  const urlParams = new URLSearchParams(window.location.search);
  for (const [key, value] of urlParams) {
    params[key] = value;
  }
  return params;
}

function getFbclid() {
  const urlParams = getUrlParameters();
  return urlParams.fbclid || undefined;
}

// ==============================================
// INICIALIZA√á√ÉO E CONFIGURA√á√ÉO
// ==============================================
const API_BASE_URL = 'https://mornatti-conversions-api.up.railway.app'; // API no mesmo dom√≠nio.
const FACEBOOK_CONVERSIONS_CONFIG = {
  currency: 'BRL',
  debugMode: true, 
};

let globalUserData = {
  external_id: getExternalId(),
  fbp: getCookie('_fbp'),
  fbc: getCookie('_fbc') || getFbclid(),
  em: undefined,
  ph: undefined,
  fn: undefined,
  ln: undefined,
  faturamento: undefined,
};

function updateUserData(newData) {
  Object.assign(globalUserData, newData);
  localStorage.setItem('fb_user_data', JSON.stringify(globalUserData));
}

function loadUserData() {
  try {
    const stored = localStorage.getItem('fb_user_data');
    if (stored) {
      const data = JSON.parse(stored);
      data.fbc = getCookie('_fbc') || getFbclid() || data.fbc;
      data.fbp = getCookie('_fbp') || data.fbp;
      data.external_id = data.external_id || getExternalId(); // Ensure external_id is always populated
      Object.assign(globalUserData, data);
    }
  } catch (error) {
    console.error('FB CAPI: Erro ao carregar dados do usu√°rio do localStorage:', error);
  }
}

function debugLog(message, data) {
  if (FACEBOOK_CONVERSIONS_CONFIG.debugMode) {
    console.log(`[FB CAPI] ${message}`, data !== undefined ? data : '');
  }
}

// ==============================================
// DEBUGGING E MONITORAMENTO (Avan√ßado)
// ==============================================
const FBConversionsDebug = {
  enabled: FACEBOOK_CONVERSIONS_CONFIG.debugMode,
  log: function(level, message, data) {
    if (!this.enabled) return;
    const timestamp = new Date().toISOString();
    const prefix = `[FB CAPI ${level.toUpperCase()}] ${timestamp}`;
    switch(level) {
      case 'info': console.info(prefix, message, data !== undefined ? data : ''); break;
      case 'warn': console.warn(prefix, message, data !== undefined ? data : ''); break;
      case 'error': console.error(prefix, message, data !== undefined ? data : ''); break;
      default: console.log(prefix, message, data !== undefined ? data : '');
    }
  },
  info: function(message, data) { this.log('info', message, data); },
  warn: function(message, data) { this.log('warn', message, data); },
  error: function(message, data) { this.log('error', message, data); },
  showUserData: function() { 
    if (!this.enabled) { console.log("Debug mode is off. Call FBConversionsDebug.enableDebug() to see data."); return;}
    console.table(globalUserData); 
  },
  enableDebug: function() {
    FACEBOOK_CONVERSIONS_CONFIG.debugMode = true;
    this.enabled = true;
    console.log("%cüöÄ Facebook Conversions API Debug Mode ATIVADO Manualmente", "background: #4267B2; color: white; padding: 10px; border-radius: 5px; font-weight: bold;");
  },
  disableDebug: function() {
    FACEBOOK_CONVERSIONS_CONFIG.debugMode = false;
    this.enabled = false;
    console.log("%cüõë Facebook Conversions API Debug Mode DESATIVADO Manualmente", "background: #ff4d4d; color: white; padding: 10px; border-radius: 5px; font-weight: bold;");
  },
  testAPI: async function() {
    if (!this.enabled) { console.log("Debug mode is off. Call FBConversionsDebug.enableDebug() to test API."); return;}
    this.info('Testando conectividade com a API (endpoint /api/track/ping)...');
    try {
      // Assumindo que sua API tem um endpoint de PING em /api/track/ping ou similar
      // Se n√£o, este teste falhar√° ou precisar√° ser ajustado.
      const response = await fetch(`${API_BASE_URL}/api/track/ping`, { method: 'POST', body: JSON.stringify({test: "ping"}) });
      if (response.ok) {
        const result = await response.json();
        this.info('API Ping Test bem-sucedido!', result);
        return true;
      } else {
        this.error('API Ping Test retornou erro', { status: response.status, statusText: response.statusText });
        try{
            const errorBody = await response.text();
            this.error('Corpo da resposta do erro do Ping Test:', errorBody);
        } catch(e){}
        return false;
      }
    } catch (error) {
      this.error('Erro de rede ao testar API Ping Test', error);
      return false;
    }
  }
};
window.FBConversionsDebug = FBConversionsDebug; // Expor para o console global

function validateConfiguration() {
  const issues = [];
  if (!globalUserData.external_id) issues.push('external_id n√£o foi gerado/carregado.');
  
  if (FACEBOOK_CONVERSIONS_CONFIG.debugMode) {
      if (!globalUserData.fbp && !globalUserData.fbc) {
        FBConversionsDebug.warn('Nenhum identificador do Facebook (_fbp/_fbc) encontrado inicialmente. Isso √© normal na primeira visita ou se os cookies foram limpos. O Pixel deve defini-los. Verifique se o Pixel est√° inicializado ANTES deste script.');
      }
      if (API_BASE_URL === 'https://sua-api-id.up.railway.app' || API_BASE_URL === 'COLOQUE_A_URL_DA_SUA_API_AQUI') {
        FBConversionsDebug.warn('API_BASE_URL parece ser um placeholder. Configure-a corretamente se sua API n√£o estiver no mesmo dom√≠nio.');
      }
  }

  if (issues.length > 0) {
    FBConversionsDebug.error('Problemas CR√çTICOS de configura√ß√£o detectados. Eventos podem n√£o ser rastreados corretamente:', issues);
  } else {
    FBConversionsDebug.info('Configura√ß√£o b√°sica da CAPI validada com sucesso.');
  }
}

// ==============================================
// FUN√á√ÉO DE ENVIO DUAL (PIXEL + CAPI)
// ==============================================
async function sendDualEvent(eventName, pixelParams, capiPayloadBuilder) {
  const eventId = generateUUID();
  
  if (typeof fbq !== 'undefined') {
    fbq('track', eventName, pixelParams, { eventID: eventId });
    debugLog(`Pixel ${eventName} enviado`, { eventId, pixelData: pixelParams });
  } else {
    FBConversionsDebug.warn(`fbq (Facebook Pixel) n√£o definido. Evento Pixel ${eventName} n√£o enviado.`);
  }
  
  const capiPayload = capiPayloadBuilder(eventId);
  // Assegurar que userData no payload CAPI n√£o tenha campos nulos ou arrays vazios
  if (capiPayload.userData) {
      Object.keys(capiPayload.userData).forEach(key => {
        const value = capiPayload.userData[key];
        if (value === undefined || value === null || (Array.isArray(value) && value.length === 0)) {
          delete capiPayload.userData[key];
        }
      });
  }
  
  let endpoint;
  switch(eventName.toLowerCase()) { //toLowerCase para robustez
    case 'pageview': endpoint = 'pageview'; break;
    case 'viewcontent': endpoint = 'viewcontent'; break;
    case 'initiatecheckout': endpoint = 'initiatecheckout'; break;
    case 'lead': endpoint = 'lead'; break;
    // Adicione outros eventos padr√µes ou customizados aqui
    // case 'purchase': endpoint = 'purchase'; break; 
    // case 'addtocart': endpoint = 'addtocart'; break;
    default:
      FBConversionsDebug.warn(`Evento CAPI "${eventName}" n√£o possui um endpoint mapeado em sendDualEvent. Enviando para /api/track/custom com eventName como par√¢metro.`);
      // Fallback para um endpoint gen√©rico de evento customizado se necess√°rio, ou simplesmente n√£o enviar.
      // Para este exemplo, vamos assumir que um endpoint customizado n√£o existe e n√£o enviar.
      // endpoint = `custom?event_name=${encodeURIComponent(eventName)}`; 
      // Ajuste: N√£o enviar se n√£o mapeado para evitar erros.
      console.warn(`Evento CAPI "${eventName}" n√£o mapeado e n√£o ser√° enviado pela CAPI.`);
      return; 
  }
  
  if (endpoint) {
    try {
      debugLog(`Enviando CAPI ${eventName}`, { endpoint: `${API_BASE_URL}/api/track/${endpoint}`, payload: capiPayload });
      const response = await fetch(`${API_BASE_URL}/api/track/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(capiPayload)
      });
      const result = await response.json();
      if (response.ok && result.success) { // Verificar result.success se a API o retornar
        FBConversionsDebug.info(`CAPI ${eventName} enviado com sucesso!`, { eventId, fbtrace_id: result.fbtrace_id, diagnostics: result.diagnostics, response: result });
      } else {
        FBConversionsDebug.error(`Erro no CAPI ${eventName}`, { status: response.status, errorData: result, payload: capiPayload });
      }
    } catch (error) {
      FBConversionsDebug.error(`Erro de REDE ao enviar CAPI ${eventName}`, { error, payload: capiPayload });
    }
  }
}

// ==============================================
// EVENT HANDLERS ESPEC√çFICOS
// ==============================================

// --- PageView Event ---
async function sendCapiPageViewOnly(eventIdOverride) { // Renomeado para evitar conflito se sendPageViewEvent for usado para dual
  const eventId = eventIdOverride || generateUUID();
  const urlParameters = getUrlParameters();
  
  if (getFbclid()) { // Atualiza fbc se fbclid estiver na URL
    globalUserData.fbc = getFbclid();
    updateUserData({ fbc: getFbclid() });
  }

  const payload = {
    eventId: eventId,
    userData: {
      external_id: globalUserData.external_id ? [globalUserData.external_id] : undefined,
      em: globalUserData.em ? [globalUserData.em] : undefined,
      ph: globalUserData.ph ? [globalUserData.ph] : undefined,
      fn: globalUserData.fn ? [globalUserData.fn] : undefined,
      ln: globalUserData.ln ? [globalUserData.ln] : undefined,
      fbc: globalUserData.fbc || undefined,
      fbp: globalUserData.fbp || undefined,
    },
    eventSourceUrl: window.location.href,
    urlParameters: urlParameters,
    actionSource: 'website'
  };

  Object.keys(payload.userData).forEach(key => {
    if (payload.userData[key] === undefined || (Array.isArray(payload.userData[key]) && payload.userData[key].length === 0)) {
      delete payload.userData[key];
    }
  });

  try {
    debugLog('Enviando PageView (CAPI Only)', payload);
    const response = await fetch(`${API_BASE_URL}/api/track/pageview`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (response.ok && result.success) {
      FBConversionsDebug.info('PageView (CAPI Only) enviado com sucesso', { eventId, fbtrace_id: result.fbtrace_id, diagnostics: result.diagnostics });
    } else {
      FBConversionsDebug.error('Erro no PageView (CAPI Only)', { status: response.status, errorData: result, payload });
    }
  } catch (error) {
    FBConversionsDebug.error('Erro de REDE ao enviar PageView (CAPI Only)', { error, payload });
  }
}

// --- ViewContent Event (CTA Section) ---
async function triggerViewContentForCTA() {
  debugLog('Disparando ViewContent para CTA');
  const productData = {
    name: 'Passaporte Acelera√ß√£o CTA',
    category: 'Landing Page CTA',
    id: 'passaporte_cta_view',
    price: 0,
  };

  const pixelParams = {
    content_name: productData.name,
    content_ids: [productData.id],
    content_category: productData.category,
    content_type: 'product', // O Pixel espera content_type para ViewContent
    value: productData.price,
    currency: FACEBOOK_CONVERSIONS_CONFIG.currency
  };

  const capiPayloadBuilder = (eventId) => ({
    eventId: eventId,
    userData: { ...globalUserData }, // Passa uma c√≥pia dos dados globais
    customData: {
      content_name: productData.name,
      content_category: productData.category,
      content_ids: [productData.id],
      content_type: 'product',
      contents: [{ id: productData.id, quantity: 1, item_price: productData.price }],
      value: productData.price,
      currency: FACEBOOK_CONVERSIONS_CONFIG.currency,
      num_items: 1
    },
    eventSourceUrl: window.location.href,
    urlParameters: getUrlParameters(),
    actionSource: 'website'
  });

  await sendDualEvent('ViewContent', pixelParams, capiPayloadBuilder);
}

// --- Lead Event (Form Submission) ---
async function triggerLeadEvent(formData) {
  // 1. Processar dados do formul√°rio e atualizar globalUserData
  const fullName = formData.nome.trim();
  const nameParts = fullName.split(' ');
  const firstName = nameParts[0];
  const lastName = nameParts.slice(1).join(' ') || firstName;

  const piiData = {
    em: formData.email.trim().toLowerCase(),
    ph: formData.telefone.replace(/\D/g, ''),
    fn: firstName,
    ln: lastName,
    faturamento: formData.faturamento,
  };
  updateUserData(piiData); // Atualiza globalUserData e localStorage
  debugLog('Dados do usu√°rio atualizados (pr√©-Lead)', globalUserData);

  // 2. Preparar e enviar evento Lead
  const leadContentName = 'Lead Passaporte Acelera√ß√£o';
  const pixelParams = { // Pixel espera 'content_name' para o evento Lead
    content_name: leadContentName,
    currency: FACEBOOK_CONVERSIONS_CONFIG.currency, // opcional, mas bom ter
    // value: 0 // opcional
  };

  const capiPayloadBuilder = (eventId) => ({
    eventId: eventId,
    userData: { ...globalUserData }, // Usa os dados atualizados
    customData: {
      content_name: leadContentName,
      content_category: 'Lead',
      lead_source: 'website_form',
      form_name: 'capture-form',
      faturamento_medio_mensal: globalUserData.faturamento, // Incluindo o faturamento
      // value e currency podem ser omitidos ou definidos. Ex: value: 0 para lead gratuito.
    },
    eventSourceUrl: window.location.href,
    urlParameters: getUrlParameters(),
    actionSource: 'website'
  });

  await sendDualEvent('Lead', pixelParams, capiPayloadBuilder);
}


// ==============================================
// INICIALIZA√á√ÉO E EVENT LISTENERS GLOBAIS
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
  loadUserData(); // Carrega dados do usu√°rio do localStorage
  debugLog('FB CAPI Script Inicializado. UserData carregado:', globalUserData);
  if (FACEBOOK_CONVERSIONS_CONFIG.debugMode) {
    console.log('%cüöÄ Facebook Conversions API Debug Mode Ativo (js/fb-conversions-api.js)', 'background: #4267B2; color: white; padding: 10px; border-radius: 5px; font-weight: bold;');
    console.log('Use FBConversionsDebug.showUserData() ou FBConversionsDebug.enableDebug() no console para ver dados/logs.');
  }
  setTimeout(validateConfiguration, 500); // Valida configura√ß√£o ap√≥s um breve delay

  // PageView CAPI (Pixel PageView j√° est√° no <head>)
  // Adia um pouco para garantir que fbp/fbc do Pixel estejam dispon√≠veis
  window.addEventListener('load', function() {
      setTimeout(async () => {
          // Atualiza fbp e fbc dos cookies caso o Pixel os tenha definido/atualizado
          globalUserData.fbp = getCookie('_fbp') || globalUserData.fbp;
          globalUserData.fbc = getCookie('_fbc') || getFbclid() || globalUserData.fbc; // Prioriza fbclid da URL atual
          updateUserData({}); // Para salvar fbp/fbc atualizados no localStorage
          debugLog('Dados de usu√°rio atualizados com _fbp/_fbc antes do PageView CAPI', globalUserData);
          await sendCapiPageViewOnly();
      }, 700); // Aumentado o delay para seguran√ßa
  });

  // ViewContent para a se√ß√£o CTA
  const ctaSection = document.getElementById('resgate');
  let viewContentForCTASent = false;
  if (ctaSection) {
    const observerOptions = { root: null, rootMargin: '0px', threshold: 0.5 };
    const observerCallback = (entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !viewContentForCTASent) {
          debugLog('CTA Section (#resgate) est√° vis√≠vel, disparando ViewContent.');
          triggerViewContentForCTA();
          viewContentForCTASent = true;
          observer.unobserve(entry.target);
        }
      });
    };
    const ctaObserver = new IntersectionObserver(observerCallback, observerOptions);
    ctaObserver.observe(ctaSection);
  } else {
    FBConversionsDebug.warn("Se√ß√£o CTA com id 'resgate' n√£o encontrada para o evento ViewContent.");
  }

  // Lead Event no submit do formul√°rio
  // A l√≥gica de submiss√£o principal (incluindo fetch para webhook) est√° em main-logic.js
  // Aqui, adicionamos um listener que se integra a essa l√≥gica existente.
  // Idealmente, main-logic.js chamaria uma fun√ß√£o daqui ap√≥s a valida√ß√£o bem-sucedida.
  // Por ora, vamos adicionar um listener que dispara ANTES da submiss√£o principal,
  // confiando que a valida√ß√£o em main-logic.js impedir√° o envio se o form for inv√°lido.

  const leadForm = document.getElementById('capture-form');
  if (leadForm) {
      // Este listener ser√° para capturar os dados e enviar o evento Lead ANTES da submiss√£o principal
      // que √© gerenciada por main-logic.js (que faz o POST para o Webhook e redirecionamento).
      // A fun√ß√£o triggerLeadEvent ser√° chamada a partir do main-logic.js

      // O addEventListener para 'submit' em main-logic.js j√° existe.
      // Precisamos modificar main-logic.js para chamar triggerLeadEvent.
      // Como n√£o posso editar main-logic.js diretamente agora, vou deixar um placeholder
      // e um coment√°rio sobre como integrar.

      // **NOTA PARA INTEGRA√á√ÉO MANUAL em js/main-logic.js:**
      // Dentro do event listener de 'submit' do 'capture-form' em js/main-logic.js,
      // AP√ìS a valida√ß√£o bem-sucedida e ANTES do fetch para o webhookUrl,
      // adicione a chamada para a fun√ß√£o de evento Lead da CAPI:
      //
      // Exemplo de como ficaria em main-logic.js:
      //
      // if (!form.checkValidity()) {
      //   // ... (c√≥digo de tratamento de erro de valida√ß√£o) ...
      //   return;
      // }
      //
      // // !!! IN√çCIO DA MODIFICA√á√ÉO SUGERIDA !!!
      // if (typeof triggerLeadEvent === 'function') {
      //   const leadFormData = {
      //     nome: document.getElementById('nome').value,
      //     email: document.getElementById('email').value,
      //     telefone: document.getElementById('telefone').value,
      //     faturamento: document.getElementById('faturamento').value
      //   };
      //   try {
      //      await triggerLeadEvent(leadFormData); // Chama a fun√ß√£o do fb-conversions-api.js
      //      FBConversionsDebug.info('Evento Lead CAPI/Pixel disparado com sucesso via main-logic.js');
      //   } catch (leadEventError) {
      //      FBConversionsDebug.error('Erro ao disparar evento Lead CAPI/Pixel via main-logic.js', leadEventError);
      //   }
      // } else {
      //   FBConversionsDebug.warn('Fun√ß√£o triggerLeadEvent n√£o encontrada. O evento Lead da CAPI pode n√£o ter sido disparado.');
      // }
      // // !!! FIM DA MODIFICA√á√ÉO SUGERIDA !!!
      //
      // // Desabilita bot√£o e mostra loading
      // submitButton.disabled = true;
      // // ... (resto do c√≥digo de submiss√£o do formul√°rio em main-logic.js) ...

      debugLog("Listener para Lead event no 'capture-form' configurado. A chamada efetiva a triggerLeadEvent deve ser feita a partir de main-logic.js.");

  } else {
    FBConversionsDebug.warn("Formul√°rio com id 'capture-form' n√£o encontrado para o evento Lead.");
  }
}); 